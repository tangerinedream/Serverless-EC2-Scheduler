#From download here: https://docs.aws.amazon.com/codepipeline/latest/userguide/tutorials-cloudformation-github.html

Parameters:


  RepositoryName:
    Description: GitHub repository name
    Type: String
    Default: test

  BranchName:
    Description: GitHub branch name
    Type: String
    Default: master


  GitHubOwner:
    Type: String

  CodePipelineOAuthToken:
    Type: String
    NoEcho: true
    
  GitHubSecret:
    Type: String
    NoEcho: true


  CodePipelineBucketName:
    Description: Name of bucket to use by the pipeline for temp artifacts
    Type: String
    Default: serverless-ec2-scheduler-codepipeline-bucket-ap-northeast-1

  CodePipelineServiceRoleArn:
      Description: Enter the ARN of the CodePipeline Role.
      Type: String

  CodeBuildServiceRoleArn:
      Description: Enter the ARN of the CodeBuild Role.
      Type: String


Outputs:
  CodePipelineWebhook:
    Description: The webhook URL generated by AWS CodePipeline, such as https://eu-central-1.webhooks.aws/trigger123456
    Value:
      !GetAtt CodePipelineWebhook.Url
#    Export:
#      Name: Serverless-EC2-Scheduler-WebHookForGitHub

Resources:

  # ------------------------------------------
  # CodeBuild Declaration
  # ------------------------------------------
  APIGLamdaSAMBuildProject:
      Type: AWS::CodeBuild::Project
      Properties:
          Name: !Sub ServerlessEC2Scheduler-APIGLamdaSAMBuildProject-${AWS::Region}
          Description: >
            Builds and Deploys the APIG and Lambda Function when GitHub repo is updated.
            SAM is used, which is why these resources aren't declared in this CloudFormation

          ServiceRole: !Ref CodeBuildServiceRoleArn



          Environment:
            ComputeType: BUILD_GENERAL1_SMALL
            Image: aws/codebuild/standard:2.0
            Type: LINUX_CONTAINER
            
            EnvironmentVariables:
            - Name: S3_CODEBUILD_BUCKET
              Type: PLAINTEXT
              Value: !Ref CodePipelineBucketName

          Artifacts:
            Type: NO_ARTIFACTS
            # Type: CODEPIPELINE
            # CodePipeline will manage artifacts

          TimeoutInMinutes: 10 # default is 60

          # For the rest of these, see: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codebuild-project-source.html
          Source:
            # BuildSpec: Commented out as default is already /buildspec.yml
            Location: https://github.com/tangerinedream/Serverless-EC2-Scheduler.git
            Type: GITHUB
            ReportBuildStatus: true
            Auth:
              Type: OAUTH
              # CodeBuild requires prior GitHub auth to CodeBuild via Mgt Console.
              # See: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codebuild-project-source.html#cfn-codebuild-project-source-location

          LogsConfig:
            CloudWatchLogs:
              Status: ENABLED


            

  # ------------------------------------------
  # WebHook to tie GitHub to CodePipeline
  # ------------------------------------------

  CodePipelineWebhook:
    Type: AWS::CodePipeline::Webhook
    Properties:
      Authentication: GITHUB_HMAC
      AuthenticationConfiguration:
        # To be filled in on GitHub repository under WebHooks section, after stack is provisioned as there is a
        #     dependency - GitHub webhook requires a target URL which is generated by this stack
        # The secret you want to use for the webhook AWS CloudFormation creates.
        #   What you put here, would then be put on GitHub in the Secret, so save a copy.  You choose it here,
        #   copy it to GitHub repo afterwards, along with webhook url
        SecretToken: !Ref GitHubSecret
      Filters:
        - JsonPath: $.ref
          MatchEquals: 'refs/heads/{Branch}'
      TargetPipeline: !Ref PipelineForSAMDeployOfAPIGLamda
      TargetAction: 
        # TargetAction is the link between the WebHook and the CodePipeline Build stage
        CodePipelineSourceStageAction
      Name: CodePipelineWebhook
      TargetPipelineVersion: !GetAtt
        - PipelineForSAMDeployOfAPIGLamda
        - Version
      RegisterWithThirdParty: true

  # ------------------------------------------
  # CodePipeline Declaration
  # ------------------------------------------
  PipelineForSAMDeployOfAPIGLamda:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub ServerlessEC2Scheduler-PipelineForSAMDeployOfAPIGLamda-${AWS::Region}
      RoleArn: !Ref CodePipelineServiceRoleArn
      ArtifactStore:
        Type: S3
        Location: !Ref CodePipelineBucketName

      # Pipeline Stages Declaration
      Stages:
        - Name: Source
          Actions:
            - Name: CodePipelineSourceStageAction

              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Version: 1
                Provider: GitHub

              Configuration:
                Owner: !Ref GitHubOwner
                Repo: !Ref RepositoryName
                Branch: !Ref BranchName
                OAuthToken: !Ref CodePipelineOAuthToken
                PollForSourceChanges: false

              OutputArtifacts:
                - Name: SourceStagePipelineOutput

                  # I get this from GitHub https://github.com/settings/tokens as a logged in GitHub user .
                  # A personal access key for your GitHub repository. This is used to provide an OAuth token for connection to your repository


        - Name: Build
          Actions:
            - Name: BuildAction

              # https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#actions-valid-providers
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: 1
                Provider: CodeBuild

              # https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#structure-configuration-examples
              # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-project.html
              Configuration:
                ProjectName: !Ref APIGLamdaSAMBuildProject
                
              InputArtifacts:
                - Name: SourceStagePipelineOutput
              OutputArtifacts:
                - Name: BuildStagePipelineOutput



